<%- include("partials/header.ejs") %>
<div class="table-header">
    <h1>Weekly Revenue Data</h1>
    <div class="input-group">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="input-search" type="search" placeholder="Search....">
    </div>
    
    <form  id="filterForm" method="GET" action="/weeklycohort">
        <select name="year" onchange="this.form.submit()">
            <option value="">Select a year</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
        </select>
    </form>
    
    
    <!-- <label for="analysisType">Select Analysis Type:</label>
    <select id="analysisType" aria-label="Select analysis type">
        <option value="revenue">Revenue</option>
        <option value="quantity">Bottle Quantity</option>
    </select> -->
    <button id="exportButton" class="exbotton" aria-label="Export data to Excel"><i class="fa-solid fa-download"></i></button>
</div>

<div class="table-container">
    <div id="loading" style="display: none;">Loading...</div>

    <div id="quantityTable">
        <table>
            <thead>
                <tr>
                    <th>Brand Name</th>
                    <% sortedUniqueWeeks.forEach(week => { %>
                        <th><%= week.replace('Week ', 'W') %></th>
                    <% }); %>
                    <th>Total Quantity</th>
                    <th>Annual Weekly Average</th>
                    <th>Last 4 Average</th>
                    <th>Last 12 Average</th>
                </tr>
            </thead>
            <thead>
                <tr>
                    <th></th>
                    <% BrandWeeklyData.forEach(({ dateRange }) => { %>
                        <th><%= dateRange %></th>
                    <% }); %>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <% const brandsSet = new Set(); %>
                <% BrandWeeklyData.forEach(({ week, brands }) => { %>
                    <% Object.keys(brands).forEach(brandName => { %>
                        <% if (!brandsSet.has(brandName)) { %>
                            <tr>
                                <td><%= brandName %></td>
                                <% let totalForBrand = 0; %>
                                <% sortedUniqueWeeks.forEach(week => { %>
                                    <% const quantity = BrandWeeklyData.find(data => data.week === week).brands[brandName] || 0; %>
                                    <td><%= quantity %></td>
                                    <% totalForBrand += quantity; %>
                                <% }); %>
                                <td><%= totalForBrand %></td>
                                
                                <td>
                                    <%= (totalForBrand / sortedUniqueWeeks.length).toFixed(2) %>
                                </td>
                                <% let last4total = 0; %>
                                <%    const last4Weeks = sortedUniqueWeeks.slice(-4);%>
                                <%    last4Weeks.forEach(week =>{ %>
                                     <%   const lastquantity = BrandWeeklyData.find(data => data.week === week).brands[brandName] || 0;%>
                                     <%  last4total += lastquantity;%>
                                    <%})%>
                    
                                <td>                                   
                                    <%= (last4total/last4Weeks.length).toFixed(2) %>
                                </td>
                                <td>
                                    <% let last12total = 0; %>
                                    <% 
                                    const last12Weeks = sortedUniqueWeeks.slice(-12);
                                    last12Weeks.forEach(week=>{
                                        const last12quantity = BrandWeeklyData.find(data => data.week === week).brands[brandName] || 0;
                                        last12total += last12quantity;
                                    })
                                    %>
                                    <%= (last12total / last12Weeks.length).toFixed(2) %>
                                </td>
                            </tr>
                            <% brandsSet.add(brandName); %>
                        <% } %>
                    <% }); %>
                <% }); %>
            </tbody>
            
            
            <tfoot>
                <tr>
                    <td>Total Quantity</td>
                    <% sortedUniqueWeeks.forEach(week => { %>
                        <td>
                            <%= weeklyTotal[week] || 0 %>
                        </td>
                    <% }); %>
                    <td>
                        <% 
                        const grandTotal = Object.values(weeklyTotal).reduce((acc, total) => acc + total, 0);
                        %>
                        <%= grandTotal %>
                    </td>
                </tr>
            </tfoot>
            
            
        </table>
    </div>
</div>

    
    
    
    
</div>

<%- include("partials/footer.ejs") %>