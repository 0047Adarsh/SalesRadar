<%- include("partials/header.ejs") %>
<div class="table-header">
    <h1>Weekly Revenue Data</h1>
    <div class="input-group">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="input-search" type="search" placeholder="Search....">
    </div>
    
    <form  id="filterForm" method="GET" action="/weeklycohort">
        <select name="year" onchange="this.form.submit()">
            <option value="">Select a year</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
        </select>
    </form>
    
    
    <!-- <label for="analysisType">Select Analysis Type:</label>
    <select id="analysisType" aria-label="Select analysis type">
        <option value="revenue">Revenue</option>
        <option value="quantity">Bottle Quantity</option>
    </select> -->
    <button id="exportButton" class="exbotton" aria-label="Export data to Excel"><i class="fa-solid fa-download"></i></button>
</div>

<div class="table-container">
    <div id="loading" style="display: none;">Loading...</div>

    <div id="quantityTable">
        <table>
            <thead>
                <tr style="position: sticky; top: 0; z-index: 200;">
                    <th>SlNo.</th>
                    <th>Brand Name</th>
                    <% sortedUniqueWeeks.forEach(week => { %>
                        <th><%= week %></th>
                    <% }); %>
                    <th>Total Quantity</th>
                </tr>
            </thead>
            <tbody>
                <% let slno = 0; %>
                <% BrandWeeklyData.forEach((weekData, brandName) => { %>
                    <tr>
                        <% slno += 1; %>
                        <td><%= slno %></td>
                        <td><%= brandName %></td>
                        <% let total = 0; %>
                        <% sortedUniqueWeeks.forEach((week, index) => { %>
                            <% const quantity = weekData.get(week) || 0; %>
                            <% const Quantity = quantity.quantity || 0; %>
                            <% total += Quantity; %>

                            <% 
                                let previousQuantity = index > 0 ? (weekData.get(sortedUniqueWeeks[index - 1]) || 0).quantity || 0 : 0; 
                                let cellColor = Quantity > previousQuantity ? '#90EE90;' : Quantity < previousQuantity ? "#ff8a8a;" : '';
                            %>
                            <td style="text-align: right; padding-right: 0; background-color: <%= cellColor %>;">
                                <%= Quantity %>
                            </td>
                        <% }); %>
                        <td><%= total %></td>
                    </tr>
                <% }); %>
            </tbody>
            <tfoot>
                <tr class="fixed-column">
                    <td>Total Quantity</td>
                    <% sortedUniqueWeeks.forEach(week => { %>
                        <td>
                            <% const weeklyTotal = WeeklyTotals.get(week) || 0; %>
                            <% const weeklyQuantityTotal = weeklyTotal.quantity || 0; %>
                            <%= weeklyQuantityTotal %>
                        </td>
                    <% }); %>
                    <td>
                        <% const grandQuantityTotal = Array.from(WeeklyTotals.values()).filter(item => 
                            item.quantity && !isNaN(item.quantity)
                        ).reduce((acc, val) => acc + (val.quantity || 0), 0); %>
                        <%= grandQuantityTotal %>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>


<%- include("partials/footer.ejs") %>